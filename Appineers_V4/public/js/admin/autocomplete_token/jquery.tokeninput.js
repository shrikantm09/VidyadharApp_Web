(function(b){var C={method:"GET",contentType:"json",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:!0,tokenLimit:null,tokenDelimiter:",",preventDuplicates:!1,tokenValue:"id",prePopulate:null,processPrePopulate:!1,idPrefix:"token-input-",extraParams:"",clientCache:!0,resultsFormatter:function(b){return"<li>"+b[this.propertyToSearch]+"</li>"},
tokenFormatter:function(b){return"<li><p>"+b[this.propertyToSearch]+"</p></li>"},onResult:null,onAdd:null,onDelete:null,onReady:null,disableDelete:!1},D={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",
inputToken:"token-input-input-token"},n={init:function(k,m){var a=b.extend({},C,m||{});return this.each(function(){b(this).data("tokenInputObject",new b.TokenList(this,k,a))})},clear:function(){this.data("tokenInputObject").clear();return this},add:function(b){this.data("tokenInputObject").add(b);return this},remove:function(b){this.data("tokenInputObject").remove(b);return this},destroy:function(b){this.data("tokenInputObject").destroy(b);return this},get:function(){return this.data("tokenInputObject").getTokens()},
getManualsettings:function(){return this.data("tokenInputObject").getManualsettings()}};b.fn.tokenInput=function(b){return n[b]?n[b].apply(this,Array.prototype.slice.call(arguments,1)):n.init.apply(this,arguments)};b.TokenList=function(k,m,a){function K(){null!==a.tokenLimit&&v>=a.tokenLimit&&(g.hide(),p())}function L(c){var e=a.tokenFormatter(c);e=b(e).addClass(a.classes.token).insertBefore(w);b("<span>"+a.deleteText+"</span>").addClass(a.classes.tokenDelete).appendTo(e).click(function(){A(b(this).parent());
l.change();return!1});var d={id:c.id};d[a.propertyToSearch]=c[a.propertyToSearch];b.data(e.get(0),"tokeninput",c);q=q.slice(0,r).concat([d]).concat(q.slice(r));r++;n(q,l);v+=1;null!==a.tokenLimit&&v>=a.tokenLimit&&(g.hide(),p());return e}function E(c){var e=a.onAdd;if(0<v&&a.preventDuplicates){var d=null;t.children().each(function(){var a=b(this),e=b.data(a.get(0),"tokeninput");if(e&&e.id===c.id)return d=a,!1});if(d){z(d);w.insertAfter(d);g.focus();return}}if(null==a.tokenLimit||v<a.tokenLimit)L(c),
K();g.val("");p();b.isFunction(e)&&e.call(l,c)}function z(b){b.addClass(a.classes.selectedToken);h=b.get(0);g.val("");p()}function y(b,e){b.removeClass(a.classes.selectedToken);h=null;0===e?(w.insertBefore(b),r--):1===e?(w.insertAfter(b),r++):(w.appendTo(t),r=v);g.focus()}function A(c){var e=b.data(c.get(0),"tokeninput"),d=a.onDelete,f=c.prevAll().length;f>r&&f--;c.remove();h=null;g.focus();q=q.slice(0,f).concat(q.slice(f+1));f<r&&r--;n(q,l);--v;null!==a.tokenLimit&&g.show().val("").focus();b.isFunction(d)&&
d.call(l,e)}function n(c,e){var d=b.map(c,function(b){return b[a.tokenValue]});e.val(d.join(a.tokenDelimiter))}function p(){x.hide().empty();u=null}function B(){x.css({position:"absolute",top:b(t).offset().top+b(t).outerHeight(),left:b(t).offset().left,width:b(t).width(),zindex:999}).show()}function M(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}function F(c,e){if(e&&e.length){x.empty();var d=b("<ul>").appendTo(x).mouseover(function(a){G(b(a.target).closest("li"))}).mousedown(function(a){E(b(a.target).closest("li").data("tokeninput"));
l.change();return!1}).hide();b.each(e,function(e,g){var f=a.resultsFormatter(g),h=g[a.propertyToSearch];f=f.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+M(h)+")(?![^<>]*>)(?![^&;]+;)","g"),h.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+M(c)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"));f=b(f).appendTo(d);e%2?f.addClass(a.classes.dropdownItem):f.addClass(a.classes.dropdownItem2);0===e&&G(f);b.data(f.get(0),"tokeninput",g)});B();a.animateDropdown?d.slideDown("fast"):d.show()}else a.noResultsText&&(x.html("<p>"+
a.noResultsText+"</p>"),B())}function G(c){c&&(u&&(b(u).removeClass(a.classes.selectedDropdownItem),u=null),c.addClass(a.classes.selectedDropdownItem),u=c.get(0))}function N(){var c=g.val().toLowerCase();c&&c.length&&(h&&y(b(h),1),c.length>=a.minChars?(a.searchingText&&(x.html("<p>"+a.searchingText+"</p>"),B()),clearTimeout(O),O=setTimeout(function(){C(c)},a.searchDelay)):p())}function C(c){var e=c+H(),d=I.get(e);if(a.clientCache&&d)F(c,d);else if(a.url){d=H();var f={data:{}};-1<d.indexOf("?")?(d=
d.split("?"),f.url=d[0],d=d[1].split("&"),b.each(d,function(a,b){var c=b.split("=");f.data[c[0]]=c[1]}),""!=a.extraParams&&(d=a.extraParams.split("&"),b.each(d,function(a,b){var c=b.split("=");f.data[c[0]]=c[1]}))):f.url=d;f.data[a.queryParam]=c;f.type=a.method;f.dataType=a.contentType;a.crossDomain&&(f.dataType="jsonp");f.success=function(d){b.isFunction(a.onResult)&&(d=a.onResult.call(l,d));I.add(e,a.jsonContainer?d[a.jsonContainer]:d);g.val().toLowerCase()===c&&F(c,a.jsonContainer?d[a.jsonContainer]:
d)};b.ajax(f)}else a.local_data&&(d=b.grep(a.local_data,function(b){return-1<b[a.propertyToSearch].toLowerCase().indexOf(c.toLowerCase())}),b.isFunction(a.onResult)&&(d=a.onResult.call(l,d)),I.add(e,d),F(c,d))}function H(){var b=a.url;"function"==typeof a.url&&(b=a.url.call());return b}"string"===b.type(m)||"function"===b.type(m)?(a.url=m,m=H(),void 0===a.crossDomain&&(-1===m.indexOf("://")?a.crossDomain=!1:a.crossDomain=location.href.split(/\/+/g)[1]!==m.split(/\/+/g)[1])):"object"===typeof m&&(a.local_data=
m);a.classes?a.classes=b.extend({},D,a.classes):a.theme?(a.classes={},b.each(D,function(b,e){a.classes[b]=e+"-"+a.theme})):a.classes=D;a.disableDelete&&(a.deleteText="");var q=[],v=0,I=new b.TokenList.Cache,O,J,g=b('<input type="text"  autocomplete="off" autocorrect="off" spellcheck="false">').css({outline:"none"}).attr("id",a.idPrefix+k.id).focus(function(){null!==a.tokenLimit&&a.tokenLimit===v||!a.hintText||(x.html("<p>"+a.hintText+"</p>"),B())}).blur(function(){p();b(this).val("")}).bind("keyup keydown blur update",
function(){if(J!==(J=g.val())){var b=J.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");P.html(b);g.width(P.width()+30)}}).keydown(function(c){switch(c.keyCode){case 37:case 39:case 38:case 40:if(b(this).val()){var e=null;e=40===c.keyCode||39===c.keyCode?b(u).next():b(u).prev();e.length&&G(e);return!1}e=w.prev();var d=w.next();e.length&&e.get(0)===h||d.length&&d.get(0)===h?37===c.keyCode||38===c.keyCode?y(b(h),0):y(b(h),1):37!==c.keyCode&&38!==c.keyCode||!e.length?
39!==c.keyCode&&40!==c.keyCode||!d.length||z(b(d.get(0))):z(b(e.get(0)));break;case 8:if(a.disableDelete)break;e=w.prev();if(b(this).val().length)1===b(this).val().length?p():setTimeout(function(){N()},5);else return h?(A(b(h)),l.change()):e.length&&z(b(e.get(0))),!1;break;case 9:case 13:case 108:case 188:if(u)return E(b(u).data("tokeninput")),l.change(),!1;break;case 27:return p(),!0;default:String.fromCharCode(c.which)&&setTimeout(function(){N()},5)}}),l=b(k).hide().val("").focus(function(){g.focus()}).blur(function(){g.blur()}),
h=null,r=0,u=null,t=b("<ul />").addClass(a.classes.tokenList).click(function(a){if((a=b(a.target).closest("li"))&&a.get(0)&&b.data(a.get(0),"tokeninput")){var c=h;h&&y(b(h),2);c===a.get(0)?y(a,2):z(a)}else h&&y(b(h),2),g.focus()}).mouseover(function(c){(c=b(c.target).closest("li"))&&h!==this&&c.addClass(a.classes.highlightedToken)}).mouseout(function(c){(c=b(c.target).closest("li"))&&h!==this&&c.removeClass(a.classes.highlightedToken)}).insertAfter(l),w=b("<li />").addClass(a.classes.inputToken).appendTo(t).append(g),
x=b("<div>").addClass(a.classes.dropdown).appendTo("body").hide(),P=b("<tester/>").insertAfter(g).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:g.css("fontSize"),fontFamily:g.css("fontFamily"),fontWeight:g.css("fontWeight"),letterSpacing:g.css("letterSpacing"),whiteSpace:"nowrap"});l.val("");k=a.prePopulate||l.data("pre");a.processPrePopulate&&b.isFunction(a.onResult)&&(k=a.onResult.call(l,k));k&&k.length&&b.each(k,function(a,b){L(b);K()});b.isFunction(a.onReady)&&a.onReady.call();
this.getManualsettings=function(){return a};this.clear=function(){t.children("li").each(function(){0===b(this).children("input").length&&A(b(this))})};this.add=function(a){E(a)};this.destroy=function(a){this.remove(a);p()};this.remove=function(a){t.children("li").each(function(){if(0===b(this).children("input").length){var c=b(this).data("tokeninput"),d=!0,f;for(f in a)if(a[f]!==c[f]){d=!1;break}d&&A(b(this))}})};this.getTokens=function(){return q}};b.TokenList.Cache=function(k){var m=b.extend({max_size:500},
k),a={},n=0;this.add=function(b,k){n>m.max_size&&(a={},n=0);a[b]||(n+=1);a[b]=k};this.get=function(b){return a[b]}}})(jQuery);